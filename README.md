# Апи для страйкбольного снаряжения

## Структура 

```
api_pro_maxss
├── app/                                    #Само API 
│   ├── label_encoder.joblib                #Кодировщик для текста
│   ├── logistic_regression_model.joblib    #Модель для классификации текста
│   ├── main.py                             #FastAPI
│   ├── multi_label_classifier_improved.h5  #Модель для классификации изображений
│   ├── schemas.py                          #Pydantic
│   ├── tfidf_vectorizer.joblib             #Векторизатор
│   └── utils.py                            #Управление текстовыми символами
│
├── model/                                  #Применяемые модели
│   ├── images_model.ipynb                  #Collab-файл, для обучения картинок
│   ├── text_model.ipynb                    #Collab-файл, для обучения текста
│   └── requirements.txt                    #Используемые зависимости
│ 
├── .gitattributes                          #Атрибут для загрузки модели для классификации изображений
├── .gitignore                              #Не допускающиеся файлы, ограниченные для коммитов
├── README.md                               #Краткая документация
├── auth.py                                 #Проверка API-ключей
├── database.py                             #Сама БД
└── requirements.txt                        #Зависимости 
```


<!--Установка-->

## API 

API для определения категорий и подкатегорий страйкбольного снаряжения по текстовым объявлениям и фотографиям. Система анализирует входные данные и возвращает классификацию для каждого обнаруженного объекта снаряжения.

## Технические требования

### Входные данные
  
  1. Текст объявления
  2. Набор фотографий (1 или более)
  3. Идентификатор поста

### Выходные данные
Для каждого обнаруженного объекта:
  1. Идентификатор объекта
  2. Определенная категория
  3. Определенная подкатегория
  4. Идентификаторы фотографий, на которых обнаружен объект

## Модели машинного обучения

### 1. Текстовая модель (TF-IDF векторизация)
Тип: Логистическая регрессия
Входные данные: Текстовые описания картинок

### 2. Модель для работы с картинками
Тип: Multi-label классификация
Обладает распознаванием категорий и подкатегорий.

## Начало работы

1. Переход на сервер и установка всех необходимых зависимостей:

```
pip install -r model/requirements.txt
```

```
pip install -r requirements.txt
```

2. Запуск API:
```
uvicorn app.main:app --reload
```
## Настройка, предобработка и обучения моделей

### 1. Текстовая модель:

1. Перейдите по файлу: text_model.ipynb, чтобы обучить модель.
2. Не забудьте сохранить свою модель.

### 2. Модель для картинок:

1. Перейдите по файлу: images_model.ipynb, чтобы обучить модель.
2. Не забудьте сохранить свою модель.

```
После обучения, будут созданы вспомогательные файлы, требующиеся для поддержки моделей: label_encoder.joblib, tfidf_vectorizer.joblib. 
```


## Настройка окружения для разработчиков

1. Проверьте, что установлен Python 3.10:
```
python --version
```
2. Создайте окружение:
```
python -m venv venv
```
```
source venv/bin/activate  #Только для Linux
```

3. Установка зависимостей для API:
```
pip install -r app/requirements.txt
```
4. Установка зависимостей для моделей:
```
pip install -r requirements.txt
```

## Запуск API сервера:
1. Проверьте наличие модели ``` multi_label_classifier_improved.h5 ``` в репозитории. Если модель отсутствует - добавьте её повторно в репозиторий и с помощью команды ```git refresh``` внесите необходимые изменения.
2. API будет доступно по: http://127.0.0.1:8000.

## Примеры запросов к API:

### Классификация по тексту 
```
curl -X POST "http://127.0.0.1:8000/predict/url" \
-H "X-API-Key: 123123" \
-H "Content-Type: application/json" \
-d '{
  "post_id": "123",
  "text": "Страйкбольный пистолет HK с тактическим фонарем"
}'
```
### Классификация по изображению

```
import requests

url = "http://127.0.0.1:8000/predict/upload"
files = [('photos', open('test.jpg', 'rb'))]
data = {'post_id': '123'}

response = requests.post(
    url,
    files=files,
    data=data,
    headers={"X-API-Key": "123123"}
)
```

### Стек технологий

ML-фреймворки: Scikit-learn, TensorFlow.

API: FastAPI.

Text Processing: Pandas, NumPy

Image Processing: pillow, OpenCV

Model Serialization: Joblib, HDF5

### Дополнительно

API-ключ - это ещё один метод аутентификации, он похож на JWT, но отличается простотой реализации и отсутствием криптографической защиты. 

### Основная информация

Адрес: ``` http://0.0.0.0:8000 ```
Аутентификация: заголовок X-API-Key с ключом ```123123```
Формат: ``` JSON ```

### Аутентификация

Запрос должен содержать http: ``` X-API-Key: 123123```. Если ключ неверный - ошибка 403 ("В доступе отказано")
